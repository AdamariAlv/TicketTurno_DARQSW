@{
    Layout = null;
    ViewData["Title"] = "Consultar Estatus de Solicitud";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Consultar Estatus - Ticket de Turno</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #313b83, #6d3f8a);
            font-family: 'Poppins', sans-serif;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .consulta-card {
            background-color: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 650px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="consulta-card text-center">
        <h3 class="fw-bold mb-4"><i class="bi bi-search me-2"></i>Consultar Estatus de Solicitud</h3>
        <form id="consultaForm">
            <div class="mb-3 text-start">
                <label class="form-label">CURP:</label>
                <input type="text" id="curpConsulta" class="form-control text-uppercase" maxlength="18" required />
            </div>
            <div class="mb-3 text-start">
                <label class="form-label">Municipio:</label>
                <select id="municipioConsulta" class="form-select" required>
                    <option value="">Seleccione...</option>
                    @foreach (var m in ViewBag.Municipios as List<TicketDeTurno.Web.Models.Municipio>)
                    {
                        <option value="@m.MunicipioId">@m.Nombre</option>
                    }
                </select>
            </div>
            <div class="mb-4 text-start">
                <label class="form-label">Número de Turno:</label>
                <input type="number" id="turnoConsulta" class="form-control" min="1" required />
            </div>

            <button type="button" id="btnConsultar" class="btn btn-light w-100 fw-semibold">
                <i class="bi bi-search me-2"></i>Consultar Estatus
            </button>
        </form>

        <div id="resultado" class="mt-4"></div>


        <a href="/Home/Index" class="btn btn-outline-light mt-4">
            <i class="bi bi-house me-2"></i>Volver al inicio
        </a>
    </div>


        <!-- Modal Editar Solicitud -->
        <div class="modal fade" id="modalEditar" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-dark">
                    <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Solicitud</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="solicitudId" />

                        <div class="mb-3">
                            <label>Municipio</label>
                            <select id="editMunicipio" class="form-select">
                                <option value="">Seleccione...</option>
                                @foreach (var m in ViewBag.Municipios as List<TicketDeTurno.Web.Models.Municipio>)
                                {
                                    <option value="@m.MunicipioId">@m.Nombre</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Nivel</label>
                            <select id="editNivel" class="form-select">
                                <option value="">Seleccione...</option>
                                @foreach (var n in ViewBag.Niveles as List<TicketDeTurno.Web.Models.Nivel>)
                                {
                                    <option value="@n.NivelId">@n.Nombre</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Tipo de Trámite</label>
                            <select id="editTramite" class="form-select">
                                <option value="">Seleccione...</option>
                                @foreach (var t in ViewBag.TiposTramite as List<TicketDeTurno.Web.Models.TipoTramite>)
                                {
                                    <option value="@t.TipoTramiteId">@t.Nombre</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Asunto</label>
                            <textarea id="editAsunto" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button id="btnGuardarCambios" class="btn btn-primary">Guardar cambios</button>
                    </div>
                </div>
            </div>
        </div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    //  CONSULTAR SOLICITUD
    $('#btnConsultar').on('click', function () {
        const curp = $('#curpConsulta').val().trim().toUpperCase();
        const municipioId = $('#municipioConsulta').val();
        const turno = $('#turnoConsulta').val();

        if (!curp || !municipioId || !turno) {
            Swal.fire('Campos vacíos', 'Por favor llena todos los campos.', 'warning');
            return;
        }

        $.get(`/Tickets/BuscarEstatus?curp=${curp}&municipioId=${municipioId}&turno=${turno}`, function (data) {
            console.log("Respuesta del servidor:", data);
            if (data.encontrado) {
                mostrarResultado(data);
            } else {
                Swal.fire('No encontrado', 'No se encontró ninguna solicitud con esos datos.', 'error');
                $('#resultado').empty();
            }
        }).fail(() => {
            Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
        });
    });

    // Mostrar resultado con botón de edición si procede
    function mostrarResultado(data) {
        let html = `
            <div class="alert alert-info text-start mt-3">
                <h5><i class="bi bi-file-earmark-text me-2"></i>Detalles de la Solicitud</h5>
                <p><strong>CURP:</strong> ${data.curp}</p>
                <p><strong>Alumno:</strong> ${data.nombre}</p>
                <p><strong>Municipio:</strong> ${data.municipio}</p>
                <p><strong>Tipo de trámite:</strong> ${data.tramite}</p>
                <p><strong>Estatus:</strong> 
                    <span class="badge ${data.estatus === 'Resuelto' ? 'bg-success' : 'bg-warning text-dark'}">
                        ${data.estatus}
                    </span>
                </p>
                <p><strong>Fecha de alta:</strong> ${data.fechaAlta}</p>
            </div>`;

        if (data.estatus !== "Resuelto") {
            html += `
                <button class="btn btn-warning mt-3 btnEditar" 
                        data-id="${data.solicitudId}">
                    <i class="bi bi-pencil-square me-1"></i>Editar solicitud
                </button>`;
        }

        $('#resultado').html(html);
    }

    //  Abrir modal al dar clic en editar (usa el método clásico que te funcionaba)
    $(document).on('click', '.btnEditar', function () {
        const id = $(this).data('id');
        console.log("ID capturado del botón:", id);

        if (!id) {
            Swal.fire('Error', 'El ID de la solicitud no es válido.', 'error');
            return;
        }

        $.get(`/Tickets/ObtenerSolicitud?id=${id}`, function (res) {
            console.log("Respuesta de ObtenerSolicitud:", res);
            if (res.ok) {
                $('#editMunicipio').val(res.municipioId);
                $('#editNivel').val(res.nivelId);
                $('#editTramite').val(res.tipoTramiteId);
                $('#editAsunto').val(res.asunto);
                $('#solicitudId').val(res.id);

                // Usamos la forma "vieja" que Bootstrap 5 aún soporta con jQuery
                $('#modalEditar').modal('show');
            } else {
                Swal.fire('Error', res.msg || 'No se pudo obtener la solicitud.', 'error');
            }
        });
    });

    // GUARDAR CAMBIOS
    $('#btnGuardarCambios').on('click', function () {
        const id = $('#solicitudId').val();
        const municipioId = $('#editMunicipio').val();
        const nivelId = $('#editNivel').val();
        const tipoTramiteId = $('#editTramite').val();
        const asunto = $('#editAsunto').val();

        if (!municipioId || !nivelId || !tipoTramiteId || !asunto.trim()) {
            Swal.fire('Campos vacíos', 'Por favor complete todos los campos.', 'warning');
            return;
        }

        $.post('/Tickets/ActualizarSolicitud', {
            id, municipioId, nivelId, tipoTramiteId, asunto
        }, function (res) {
            // Cierra el modal y limpia backdrop
            $('#modalEditar').modal('hide');
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', 'auto');

            if (res.ok) {
                Swal.fire('Actualizado', res.msg, 'success');
                $('#resultado').empty();

                        $('#consultaForm')[0].reset(); // limpia formulario principal
        $('#resultado').empty();       // limpia resultado
        $('#solicitudId').val('');
            } 
            
            
            else {
                Swal.fire('Error', res.msg || 'No se pudo actualizar la solicitud.', 'error');
            }
        });
    });

    // Limpieza adicional global (por si acaso)
    $(document).on('hidden.bs.modal', '.modal', function () {
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open').css('overflow', 'auto');
    });
</script>




</body>
</html>
