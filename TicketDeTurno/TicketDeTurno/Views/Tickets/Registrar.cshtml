@model TicketDeTurno.Web.Models.Solicitud
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Registrar Solicitud - Ticket de Turno</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
    <style>
        body {
            background: linear-gradient(135deg, #4A56D3, #6F7BF9);
            font-family: 'Poppins', sans-serif;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-card {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 40px;
            width: 700px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        label {
            color: #fff;
            font-weight: 500;
        }

        .form-control, select, textarea {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            border-radius: 10px;
        }

            .form-control:focus {
                box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.3);
            }

        .btn-submit {
            background-color: #4A5BFA;
            border: none;
            border-radius: 10px;
            width: 100%;
            padding: 12px;
            font-weight: 600;
            color: #fff;
            transition: all 0.3s ease;
        }

            .btn-submit:hover {
                background-color: #5E6FFF;
                transform: translateY(-2px);
            }
    </style>
</head>
<body>
    <div class="form-card">
        <h3 class="text-center mb-4"><i class="bi bi-ui-checks me-2"></i> Registrar Solicitud</h3>
        <form asp-action="Registrar" method="post" id="formTicket">
            <div class="row g-3">
                <div class="col-md-6">
                    <label>CURP</label>
                    <div class="input-group">
                        <input type="text" name="CURP" id="CURP" class="form-control" required maxlength="18" />
                        <button type="button" id="btnValidarCurp" class="btn btn-outline-light">Validar</button>
                    </div>
                    <div id="curpStatus" class="form-text text-light"></div>
                </div>
                <h5 class="mt-4 mb-2 fw-semibold text-white">Datos del Alumno</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label>Nombre</label>
                        <input type="text" name="Alumno.Nombre" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label>Apellido paterno</label>
                        <input type="text" name="Alumno.Paterno" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label>Apellido materno</label>
                        <input type="text" name="Alumno.Materno" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label>Teléfono</label>
                        <input type="text" name="Alumno.Telefono" class="form-control" maxlength="20" />
                    </div>
                    <div class="col-md-6">
                        <label>Correo</label>
                        <input type="email" name="Alumno.Correo" class="form-control" />
                    </div>
                </div>
                <div class="col-md-6">
                    <label>Quién realiza el trámite</label>
                    <input type="text" name="QuienRealiza" class="form-control" required />
                </div>
                <div class="col-md-4">
                    <label>Municipio</label>
                    <select name="MunicipioId" class="form-select" required>
                        <option value="">Seleccione...</option>
                        @foreach (var m in ViewBag.Municipios)
                        {
                            <option value="@m.MunicipioId">@m.Nombre</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Nivel</label>
                    <select name="NivelId" class="form-select" required>
                        <option value="">Seleccione...</option>
                        @foreach (var n in ViewBag.Niveles)
                        {
                            <option value="@n.NivelId">@n.Nombre</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Tipo de Trámite</label>
                    <select name="TipoTramiteId" class="form-select" required>
                        <option value="">Seleccione...</option>
                        @foreach (var t in ViewBag.TiposTramite)
                        {
                            <option value="@t.TipoTramiteId">@t.Nombre</option>
                        }
                    </select>
                </div>
                <div class="col-12">
                    <label>Asunto o descripción breve</label>
                    <textarea name="Asunto" rows="3" class="form-control"></textarea>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-submit mt-3">Registrar Solicitud</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        const regexCurp = /^[A-Z]{4}\d{6}[A-Z]{6}[0-9A-Z]{2}$/i;
        const curpInput = document.getElementById("CURP");
        const statusDiv = document.getElementById("curpStatus");
        const btnValidar = document.getElementById("btnValidarCurp");

        function setStatus(msg, ok) {
          statusDiv.innerText = msg;
          statusDiv.className = ok ? "form-text text-success" : "form-text text-warning";
        }

        btnValidar.addEventListener("click", async () => {
          const curp = curpInput.value.trim().toUpperCase();
          if (!regexCurp.test(curp)) {
            Swal.fire({icon:"error", title:"CURP inválida", text:"Verifica el formato (18 caracteres)."});
            return;
          }
          try {
            setStatus("Consultando RENAPO...", false);
            const res = await fetch(`/Tickets/ValidarCurp?curp=${encodeURIComponent(curp)}`);
            const data = await res.json();
            if (data.ok) {
              setStatus("CURP encontrada en RENAPO (demo).", true);
            } else {
              setStatus("CURP no encontrada en RENAPO (demo).", false);
            }
          } catch (e) {
            setStatus("No se pudo consultar RENAPO. Continuarás solo con validación local.", false);
          }
        });

        // Bloquea submit si CURP no cumple formato
        document.getElementById("formTicket")?.addEventListener("submit", function(e) {
          const curp = curpInput.value.trim();
          if (!regexCurp.test(curp)) {
            e.preventDefault();
            Swal.fire({icon:"error", title:"CURP inválida", text:"Por favor ingresa una CURP válida."});
          }
        });
    </script>
</body>
</html>
