@{
    ViewData["Title"] = "Dashboard";
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<!-- 🔹 Filtros -->
<div class="row mb-4">
    <div class="col-md-3">
        <label>Municipio</label>
        <select id="filtroMunicipio" class="form-select">
            <option value="">Todos</option>
            @foreach (var m in ViewBag.Municipios)
            {
                <option value="@m.Nombre">@m.Nombre</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <label>Nivel</label>
        <select id="filtroNivel" class="form-select">
            <option value="">Todos</option>
            @foreach (var n in ViewBag.Niveles)
            {
                <option value="@n.Nombre">@n.Nombre</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <label>Tipo de Trámite</label>
        <select id="filtroTramite" class="form-select">
            <option value="">Todos</option>
            @foreach (var t in ViewBag.TiposTramite)
            {
                <option value="@t.Nombre">@t.Nombre</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <label>Solicitud</label>
        <select id="filtroSolicitud" class="form-select">
            <option value="">Todos</option>
            @foreach (var s in ViewBag.Solicitudes)
            {
                <option value="@s">@s</option>
            }
        </select>
    </div>
</div>

<!-- 🔹 Tarjeta de resumen -->
<div class="card mb-4 shadow">
    <div class="card-body">
        <h5>Total de solicitudes: <span id="totalSolicitudes" class="fw-bold text-primary">0</span></h5>
    </div>
</div>

<!-- 🔹 Gráficos -->
<div class="row">
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">Solicitudes por Municipio</div>
            <div class="card-body"><canvas id="chartMunicipio"></canvas></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white">Solicitudes por Nivel</div>
            <div class="card-body"><canvas id="chartNivel"></canvas></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-warning text-white">Solicitudes por Tipo de Trámite</div>
            <div class="card-body"><canvas id="chartTramite"></canvas></div>
        </div>
    </div>
    <hr class="my-5" />

    <h3 class="fw-bold mb-3"><i class="bi bi-geo text-primary me-2"></i>Turnos generados por municipio (SP)</h3>

    <div class="row mb-3">
        <div class="col-md-4">
            <select id="spMunicipio" class="form-select">
                <option value="">Seleccione un municipio...</option>
                @foreach (var m in ViewBag.Municipios)
                {
                    <option value="@m.MunicipioId">@m.Nombre</option>
                }
            </select>
        </div>
    </div>

    <table class="table table-hover table-bordered shadow-sm" id="tablaSP" style="display:none;">
        <thead class="table-dark">
            <tr>
                <th>Turno</th>
                <th>CURP</th>
                <th>Estatus</th>
                <th>Fecha Alta</th>
            </tr>
        </thead>
        <tbody id="bodySP"></tbody>
    </table>

    <!-- graficos de las vistas sql-->
    <hr class="my-5" />
    <h3 class="fw-bold mb-3"><i class="bi bi-list-ul me-2"></i>Solicitudes (Vista)</h3>

    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Turno</th>
                    <th>CURP</th>
                    <th>Alumno</th>
                    <th>Municipio</th>
                    <th>Nivel</th>
                    <th>Trámite</th>
                    <th>Estatus</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in ViewBag.VistaDetalle)
                {
                    <tr>
                        <td>@s.NumeroTurno</td>
                        <td>@s.CURP</td>
                        <td>@s.Alumno</td>
                        <td>@s.Municipio</td>
                        <td>@s.Nivel</td>
                        <td>@s.Tramite</td>
                        <td>@s.Estatus</td>
                        <td>@s.FechaAlta.ToShortDateString()</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <hr class="my-5" />
    <h3 class="fw-bold mb-3"><i class="bi bi-calendar-week me-2"></i>Turnos por Día (Vista)</h3>

    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-primary">
                <tr>
                    <th>Fecha</th>
                    <th>Total Solicitudes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in ViewBag.VistaTurnosDia)
                {
                    <tr>
                        <td>@t.Fecha.ToShortDateString()</td>
                        <td>@t.TotalSolicitudes</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <hr class="my-5" />
    <h3 class="fw-bold mb-3"><i class="bi bi-people me-2"></i>Alumnos (Vista)</h3>

    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>CURP</th>
                    <th>Alumno</th>
                    <th>Municipio</th>
                    <th>Nivel</th>
                    <th>Teléfono</th>
                    <th>Correo</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var a in ViewBag.VistaAlumnos)
                {
                    <tr>
                        <td>@a.CURP</td>
                        <td>@a.Alumno</td>
                        <td>@a.Municipio</td>
                        <td>@a.Nivel</td>
                        <td>@a.Telefono</td>
                        <td>@a.Correo</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>


</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let charts = {};

        async function cargarDatos() {
            const municipio = document.getElementById('filtroMunicipio')?.value || '';
            const nivel = document.getElementById('filtroNivel')?.value || '';
            const tramite = document.getElementById('filtroTramite')?.value || '';
            const solicitud = document.getElementById('filtroSolicitud')?.value || '';

            const response = await fetch(`/Dashboard/ObtenerDatos?municipio=${municipio}&nivel=${nivel}&tipoTramite=${tramite}&solicitud=${solicitud}`);
            const data = await response.json();

            // Total
            document.getElementById('totalSolicitudes').textContent = data.total;

            // Renderizar los gráficos
            renderPieChart('chartMunicipio', 'Solicitudes por Municipio', data.municipio);
            renderBarChart('chartNivel', 'Solicitudes por Nivel Educativo', data.nivel);
            renderPieChart('chartTramite', 'Solicitudes por Tipo de Trámite', data.tramite);
        }

        // Gráfico circular (doughnut)
        function renderPieChart(id, title, data) {
            const ctx = document.getElementById(id);
            if (charts[id]) charts[id].destroy();

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(x => x.label),
                    datasets: [{
                        label: title,
                        data: data.map(x => x.valor),
                        backgroundColor: generarColores(data.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 18 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Gráfico de barras comparativas
        function renderBarChart(id, title, data) {
            const ctx = document.getElementById(id);
            if (charts[id]) charts[id].destroy();

            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(x => x.label),
                    datasets: [{
                        label: title,
                        data: data.map(x => x.valor),
                        backgroundColor: generarColores(data.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 18 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Generar colores aleatorios
        function generarColores(cantidad) {
            const colores = [];
            for (let i = 0; i < cantidad; i++) {
                const color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                colores.push(color);
            }
            return colores;
        }

        // Cargar al inicio
        cargarDatos();

        // Actualizar cuando cambie un filtro
        document.querySelectorAll('#filtroMunicipio, #filtroNivel, #filtroTramite, #filtroSolicitud')
            .forEach(select => select.addEventListener('change', cargarDatos));

        // JS para sp
        document.getElementById("spMunicipio").addEventListener("change", async function () {
            const id = this.value;

            if (!id) {
                document.getElementById("tablaSP").style.display = "none";
                return;
            }

            const res = await fetch(`/Dashboard/ObtenerTurnosSP?municipioId=${id}`);
            const datos = await res.json();

            let cuerpo = "";

            datos.forEach(s => {
                cuerpo += `
                    <tr>
                        <td>${s.numeroTurno}</td>
                        <td>${s.curp}</td>
                        <td>${s.estatus}</td>
                        <td>${new Date(s.fechaAlta).toLocaleDateString()}</td>
                    </tr>
                `;
            });

            document.getElementById("bodySP").innerHTML = cuerpo;
            document.getElementById("tablaSP").style.display = "";
        });

    </script>
}
